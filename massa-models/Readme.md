## Generating C bindings

    cd massa-models
    cargo build -j 8
    cbindgen --config cbindgen.toml -d --crate massa_models --output massa_models.h

## Building C program

```C
#include <stdio.h>
// #include "../../../massa2/massa-models/massa_models.h"
#include "massa_models.h"

int main() {
    // printf() displays the string inside quotation
    printf("Hello, World!\n");

    // Variables

    Slot* slot1 = NULL;
    Slot* slot1_der = NULL;
    // uint8_t* buffer = NULL;

    // End Variables

    // C playground

    uint8_t* buf0 = malloc(2);
    buf0[0] = 1;
    buf0[1] = 7;
    printf("buf0 values: %d %d\n", buf0[0], buf0[1]);
    free(buf0);

    // End C playground

    slot1 = new_slot(1, 7);
    printf("Successfully created new slot: %ld - %d\n", slot1->Period, slot1->Thread);

    struct CBuffer cbuffer = slot_serialize(slot1);
    printf("cbuffer len: %ld\n", cbuffer.Len);
    printf("cbuffer values: %d %d\n", cbuffer.Ptr[0], cbuffer.Ptr[1]);

    slot1_der = slot_deserialize(cbuffer);
    printf("Successfully der slot: %ld - %d\n", slot1_der->Period, slot1_der->Thread);

    free_slot(slot1);
    free_slot(slot1_der);

    return 0;
}
```

    LC_ALL="C" gcc main.c -o main_c_1 -I ../../../massa2/massa-models/ -L. -l:../../../massa2/target/debug/libmassa_models.so && ./main_c_1

### Valgrind check

    valgrind --leak-check=full --show-leak-kinds=all  ./main_c_1

## Python bindings (CFFI)

    python3 -m venv venv
    venv/bin/python -m pip install cffi

### Python bindings: tasks.py

```python
# tasks.py
import pathlib

import cffi

""" Build the CFFI Python bindings """
print("Building CFFI Module")
ffi = cffi.FFI()

this_dir = pathlib.Path().absolute()
h_file_name = this_dir / "massa_models.h"
with open(h_file_name) as h_file:
    ffi.cdef(h_file.read())

ffi.set_source(
    "massa_models_py",
    # Since you're calling a fully-built library directly, no custom source
    # is necessary. You need to include the .h files, though, because behind
    # the scenes cffi generates a .c file that contains a Python-friendly
    # wrapper around each of the functions.
    '#include "massa_models.h"',
    # The important thing is to include the pre-built lib in the list of
    # libraries you're linking against:
    libraries=["massa_models"],
    library_dirs=[this_dir.as_posix()],
    extra_link_args=["-Wl,-rpath,."],
)

ffi.compile()
```

Note: 
* Need (for now) manual processing of massa_models.h
  * Some "#define" are not supported by python-cffi
  * Can we automate this process?
    * Contribute to python-cffi project?

### Python bindings: howto use

```python
import massa_models_py

if __name__ == "__main__":

    print("Hello")
    print(dir(massa_models_py.lib))

    slot1 = massa_models_py.lib.new_slot(1, 7)
    slot1_ser = massa_models_py.lib.slot_serialize(slot1)
    print("slot1", slot1, slot1.Period, slot1.Thread);
    print("slot1 ser", slot1_ser)
    slot1_ser = massa_models_py.lib.slot_serialize(slot1)

    slot1_der = massa_models_py.lib.slot_deserialize(slot1_ser);
    print("slot1 der", slot1_der, slot1_der.Period, slot1_der.Thread)
```

## Go bindings

### Setup

    go install -v github.com/xlab/c-for-go@latest

### massa_models.yml (WIP)

```yaml
GENERATOR:
  PackageName: massa_models
  PackageDescription: "Package vorbis provides Go bindings for OggVorbis implementation by the Xiph.Org Foundation"
  PackageLicense: "THE AUTOGENERATED LICENSE. ALL THE RIGHTS ARE RESERVED BY ROBOTS."
  # PkgConfigOpts: [massa_models]
  Includes: ["massa_models.h",]
PARSER:
  IncludePaths: [
    "/usr/include",
    "/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include",
  ]
  SourcesPaths: ["massa_models.h"]
TRANSLATOR: 
  ConstRules: 
    defines: eval
  # TypeTips:
  #   function:
  #     - { target: "Slot", self: plain, tips: [ plain,plain,plain,plain,plain ] }
  PtrTips:
    function:
      - {target: "vorbis_analysis_headerout$", tips: [sref,sref,sref,sref,sref]}
      - {target: "vorbis_synthesis_pcmout$", tips: [ref,arr]}
      - {target: ^vorbis_, tips: [ref,ref,ref]}
      - {target: ^ogg_, self: arr, tips: [ref,ref]}
  Rules: 
    global: 
      - {transform: lower}
      - {action: accept, from: "^Slot"}
      - {action: accept, from: "^CBuffer"}
      - {action: accept, from: "^slot_"}
      - {action: accept, from: "^new_"}
      - {action: accept, from: "^free_"}
      # - {action: accept, from: "^vorbis_"}
      # - {action: accept, from: "^ogg_"}
      # - {action: replace, from: "^vorbis_", to: _}
      - {transform: export}
    const:
      - {action: accept, from: "NETWORK_"}
      # - {action: accept, from: "^OV_"}
      # - {action: replace, from: "^ov_", to: _}
    type: 
      # - {action: replace, from: "_t$"}
      # - {action: replace, from: "Slot"}
    private:
      - {transform: unexport}
    post-global: 
      - {action: doc, from: "^ogg_u?int[0-9]+_t"} # types like ogg_uint32_t
      - {action: doc, from: "^ogg_", to: "https://xiph.org/ogg/doc/libogg/$name.html"}
      - {action: doc, from: "^vorbis_", to: "https://xiph.org/vorbis/doc/libvorbis/$name.html"}
      - {action: replace, from: _$}
      - {load: snakecase}
```

```Makefile
all:
	~/go/bin/c-for-go -debug -fancy massa_models.yml

clean:
	rm -f massa_models/cgo_helpers.go massa_models/cgo_helpers.h massa_models/doc.go massa_models/types.go massa_models/const.go
	rm -f massa_models/massa_models.go

test:
	cd massa_models && go build
```
